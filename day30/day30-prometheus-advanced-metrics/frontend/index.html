<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prometheus Metrics Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231e293b'/%3E%3Cpath d='M32 12l4.2 12.4h13L38.6 33l4.2 12.4L32 37.8l-10.8 7.6L25.4 33 14.8 24.4h13z' fill='%23f97316'/%3E%3Ccircle cx='32' cy='45' r='5' fill='%23fb923c'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
            font-size: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f8fafc;
        }

        .card-subtitle {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-healthy {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        .status-warning {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .status-error {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .metrics-section {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #f8fafc;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .metric-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .alert-badges {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }

        .alert-badge {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .alert-badge-critical {
            border-color: rgba(239, 68, 68, 0.6);
            color: #fecaca;
        }

        .alert-badge-warning {
            border-color: rgba(245, 158, 11, 0.6);
            color: #fde68a;
        }

        .alert-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.6);
            border-left: 4px solid;
        }

        .alert-critical {
            border-left-color: #ef4444;
        }

        .alert-warning {
            border-left-color: #f59e0b;
        }

        .alert-resolved {
            border-left-color: #22c55e;
        }

        .alert-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 0.75rem;
            color: #64748b;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .links-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 24px;
        }

        .link-card {
            display: block;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            text-decoration: none;
            color: #e2e8f0;
            transition: all 0.2s;
            text-align: center;
        }

        .link-card:hover {
            background: rgba(15, 23, 42, 0.8);
            transform: translateY(-2px);
        }

        .link-card-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .link-card-url {
            font-size: 0.75rem;
            color: #64748b;
        }

        .progress-bar {
            height: 8px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-success {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        .progress-warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .progress-error {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .timestamp {
            text-align: center;
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        const { useState, useEffect, useCallback } = React;
        const html = htm.bind(React.createElement);

        function Dashboard() {
            const [dashboardData, setDashboardData] = useState(null);
            const [alerts, setAlerts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);

            const fetchData = useCallback(async () => {
                try {
                    const [dashResponse, alertsResponse] = await Promise.all([
                        fetch('http://localhost:8000/dashboard/data'),
                        fetch('http://localhost:8000/alerts')
                    ]);

                    if (!dashResponse.ok || !alertsResponse.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const dashData = await dashResponse.json();
                    const alertsData = await alertsResponse.json();

                    setDashboardData(dashData);
                    setAlerts(alertsData.alerts || []);
                    setLastUpdate(new Date().toLocaleTimeString());
                    setError(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [fetchData]);

            const simulateOrders = async () => {
                try {
                    await fetch('http://localhost:8000/orders/simulate?count=20');
                    fetchData();
                } catch (err) {
                    console.error('Failed to simulate orders:', err);
                }
            };

            const triggerErrors = async () => {
                try {
                    for (let i = 0; i < 10; i++) {
                        fetch('http://localhost:8000/error').catch(() => {});
                    }
                } catch (err) {
                    console.error('Failed to trigger errors:', err);
                }
            };

            const getHealthStatus = () => {
                if (!dashboardData) return 'status-warning';
                if (alerts.length > 5) return 'status-error';
                if (alerts.length > 0) return 'status-warning';
                return 'status-healthy';
            };

            if (loading) {
                return html`
                    <div className="dashboard">
                        <div className="header">
                            <h1>Loading Dashboard...</h1>
                        </div>
                    </div>
                `;
            }

            return html`
                <div className="dashboard">
                    <div className="header">
                        <h1>Prometheus Metrics Dashboard</h1>
                        <p>Day 30: Advanced Metrics & High Availability Monitoring</p>
                    </div>

                    ${error && html`
                        <div className="card" style=${{background: 'rgba(239, 68, 68, 0.2)', marginBottom: '20px'}}>
                            <p>Error: ${error}</p>
                        </div>
                    `}

                    <div className="grid">
                        <div className="card">
                            <div className="card-header">
                                <span className="card-title">Active Users</span>
                                <div className=${`status-indicator ${getHealthStatus()}`}></div>
                            </div>
                            <div className="card-value">
                                ${dashboardData?.metrics?.active_users?.toLocaleString() || '—'}
                            </div>
                            <div className="card-subtitle">Currently online</div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <span className="card-title">Order Queue</span>
                            </div>
                            <div className="card-value">
                                ${dashboardData?.metrics?.queues?.orders || '—'}
                            </div>
                            <div className="card-subtitle">Pending orders</div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <span className="card-title">Active Alerts</span>
                            </div>
                            <div className="card-value" style=${{color: alerts.length > 0 ? '#f59e0b' : '#22c55e'}}>
                                ${alerts.length}
                            </div>
                            <div className="card-subtitle">From Alertmanager</div>
                            ${(() => {
                                const activeAlerts = alerts
                                    .filter(alert => (alert.data?.status || 'firing') !== 'resolved')
                                    .slice(0, 2);
                                if (!activeAlerts.length) return null;
                                return html`
                                    <div className="alert-badges">
                                        ${activeAlerts.map(alert => {
                                            const details = alert.data?.alerts?.[0];
                                            const severity = details?.labels?.severity || 'warning';
                                            const badgeClass = severity === 'critical' ? 'alert-badge-critical' : 'alert-badge-warning';
                                            return html`
                                                <div className=${`alert-badge ${badgeClass}`}>
                                                    <span>${details?.labels?.alertname || 'Unknown Alert'}</span>
                                                    <span>${severity}</span>
                                                </div>
                                            `;
                                        })}
                                    </div>
                                `;
                            })()}
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <span className="card-title">DB Connections</span>
                            </div>
                            <div className="card-value">
                                ${dashboardData?.metrics?.database?.active || '—'}
                            </div>
                            <div className="card-subtitle">
                                ${dashboardData?.metrics?.database?.idle || '—'} idle
                            </div>
                        </div>
                    </div>

                    <div className="metrics-section">
                        <h3 className="section-title">Queue Status</h3>
                        ${dashboardData?.metrics?.queues ? Object.entries(dashboardData.metrics.queues).map(([name, depth]) => html`
                            <div key=${name} className="metric-row">
                                <span className="metric-label">${name}</span>
                                <div style=${{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                    <span className="metric-value">${depth}</span>
                                    <div style=${{width: '100px'}}>
                                        <div className="progress-bar">
                                            <div
                                                className=${`progress-fill ${depth > 75 ? 'progress-error' : depth > 50 ? 'progress-warning' : 'progress-success'}`}
                                                style=${{width: `${Math.min(depth, 100)}%`}}
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `) : null}
                    </div>

                    <div className="metrics-section">
                        <h3 className="section-title">Test Actions</h3>
                        <div className="button-group">
                            <button type="button" className="btn btn-primary" onClick=${simulateOrders}>
                                Generate Orders
                            </button>
                            <button type="button" className="btn btn-secondary" onClick=${triggerErrors}>
                                Trigger Errors
                            </button>
                            <button type="button" className="btn btn-secondary" onClick=${fetchData}>
                                Refresh Data
                            </button>
                        </div>
                    </div>

                    <div className="metrics-section">
                        <h3 className="section-title">Recent Alerts</h3>
                        <div className="alert-list">
                            ${alerts.length === 0 ? html`
                                <p style=${{color: '#64748b', textAlign: 'center', padding: '20px'}}>
                                    No alerts received
                                </p>
                            ` : alerts.slice(0, 10).map((alert, index) => {
                                const status = alert.data?.status || 'unknown';
                                const alertClass = status === 'resolved'
                                    ? 'alert-resolved'
                                    : alert.data?.alerts?.[0]?.labels?.severity === 'critical'
                                        ? 'alert-critical'
                                        : 'alert-warning';
                                return html`
                                    <div key=${index} className=${`alert-item ${alertClass}`}>
                                        <div className="alert-title">
                                            ${alert.data?.alerts?.[0]?.labels?.alertname || 'Unknown Alert'}
                                            <span style=${{marginLeft: '8px', opacity: 0.7}}>
                                                [${status}]
                                            </span>
                                        </div>
                                        <div className="alert-time">${alert.received_at}</div>
                                    </div>
                                `;
                            })}
                        </div>
                    </div>

                    <div className="metrics-section">
                        <h3 className="section-title">Monitoring Endpoints</h3>
                        <div className="links-section">
                            <a href="http://localhost:9090" target="_blank" className="link-card">
                                <div className="link-card-title">Prometheus 0</div>
                                <div className="link-card-url">localhost:9090</div>
                            </a>
                            <a href="http://localhost:9091" target="_blank" className="link-card">
                                <div className="link-card-title">Prometheus 1</div>
                                <div className="link-card-url">localhost:9091</div>
                            </a>
                            <a href="http://localhost:10904" target="_blank" className="link-card">
                                <div className="link-card-title">Thanos Query</div>
                                <div className="link-card-url">localhost:10904</div>
                            </a>
                            <a href="http://localhost:9093" target="_blank" className="link-card">
                                <div className="link-card-title">Alertmanager</div>
                                <div className="link-card-url">localhost:9093</div>
                            </a>
                            <a href="http://localhost:9001" target="_blank" className="link-card">
                                <div className="link-card-title">MinIO Console</div>
                                <div className="link-card-url">localhost:9001</div>
                            </a>
                            <a href="http://localhost:8000/metrics" target="_blank" className="link-card">
                                <div className="link-card-title">App Metrics</div>
                                <div className="link-card-url">localhost:8000/metrics</div>
                            </a>
                        </div>
                    </div>

                    ${lastUpdate && html`
                        <div className="timestamp">
                            Last updated: ${lastUpdate}
                        </div>
                    `}
                </div>
            `;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(html`<${Dashboard} />`);
    </script>
</body>
</html>
