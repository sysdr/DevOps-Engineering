import pytest
from fastapi.testclient import TestClient
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from app.main import app

client = TestClient(app)

def test_root():
    response = client.get("/")
    assert response.status_code == 200
    assert "Vulnerability Management System" in response.json()["message"]

def test_trigger_sast_scan():
    response = client.post("/api/scans/trigger", json={
        "scan_type": "sast",
        "target": "scan-targets/vulnerable-app",
        "priority": "high"
    })
    assert response.status_code == 200
    assert "job_id" in response.json()

def test_trigger_container_scan():
    response = client.post("/api/scans/trigger", json={
        "scan_type": "container",
        "target": "python:3.9-slim",
        "priority": "medium"
    })
    assert response.status_code == 200
    assert response.json()["status"] == "queued"

def test_get_vulnerabilities():
    response = client.get("/api/vulnerabilities")
    assert response.status_code == 200
    assert "vulnerabilities" in response.json()
    assert "total" in response.json()

def test_get_dashboard_stats():
    response = client.get("/api/dashboard/stats")
    assert response.status_code == 200
    data = response.json()
    assert "total_vulnerabilities" in data
    assert "by_severity" in data
    assert "by_status" in data
    assert "compliance_score" in data

def test_get_compliance_report():
    response = client.get("/api/reports/compliance")
    assert response.status_code == 200
    data = response.json()
    assert "frameworks" in data
    assert "PCI-DSS" in data["frameworks"]
    assert "SOC2" in data["frameworks"]
    assert "overall_compliance" in data

def test_scan_history():
    response = client.get("/api/scans/history")
    assert response.status_code == 200
    assert "scans" in response.json()

def test_filter_vulnerabilities_by_severity():
    response = client.get("/api/vulnerabilities?severity=critical")
    assert response.status_code == 200

def test_update_vulnerability_status():
    # First get a vulnerability
    response = client.get("/api/vulnerabilities")
    if response.json()["total"] > 0:
        vuln_id = response.json()["vulnerabilities"][0]["id"]
        
        # Update its status
        response = client.patch(f"/api/vulnerabilities/{vuln_id}?status=in_progress")
        assert response.status_code == 200
        assert response.json()["status"] == "in_progress"
