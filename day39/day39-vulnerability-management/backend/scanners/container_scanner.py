import subprocess
import json
from typing import List, Dict

class ContainerScanner:
    """Container vulnerability scanning using Trivy"""
    
    def __init__(self):
        self.scanner_name = "trivy"
    
    def scan_image(self, image_name: str) -> List[Dict]:
        """Scan Docker image for vulnerabilities"""
        try:
            result = subprocess.run(
                ["trivy", "image", "--format", "json", "--quiet", image_name],
                capture_output=True,
                text=True,
                timeout=120
            )
            
            if result.stdout:
                data = json.loads(result.stdout)
                return self.parse_results(data, image_name)
            return []
            
        except Exception as e:
            print(f"Container scan error: {e}")
            return []
    
    def parse_results(self, data: Dict, image: str) -> List[Dict]:
        findings = []
        
        if "Results" in data:
            for result in data["Results"]:
                if "Vulnerabilities" in result:
                    for vuln in result["Vulnerabilities"]:
                        severity_map = {
                            "CRITICAL": "critical",
                            "HIGH": "high",
                            "MEDIUM": "medium",
                            "LOW": "low"
                        }
                        
                        finding = {
                            "type": "container",
                            "severity": severity_map.get(vuln.get("Severity", "LOW"), "low"),
                            "cve_id": vuln.get("VulnerabilityID", ""),
                            "package": vuln.get("PkgName", ""),
                            "version": vuln.get("InstalledVersion", ""),
                            "fixed_version": vuln.get("FixedVersion", ""),
                            "title": vuln.get("Title", "")
                        }
                        findings.append(finding)
        
        return findings

def run_container_scan(image_name: str) -> Dict:
    scanner = ContainerScanner()
    findings = scanner.scan_image(image_name)
    
    return {
        "scanner": "Container (Trivy)",
        "target": image_name,
        "findings_count": len(findings),
        "findings": findings
    }
