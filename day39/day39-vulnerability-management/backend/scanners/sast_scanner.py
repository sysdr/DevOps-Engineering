import subprocess
import json
from pathlib import Path
from typing import List, Dict

class SASTScanner:
    """Static Application Security Testing using Bandit"""
    
    def __init__(self):
        self.scanner_name = "bandit"
    
    def scan(self, target_path: str) -> List[Dict]:
        """Run SAST scan on Python code"""
        try:
            result = subprocess.run(
                ["bandit", "-r", target_path, "-f", "json"],
                capture_output=True,
                text=True,
                timeout=60
            )
            
            if result.stdout:
                data = json.loads(result.stdout)
                return self.parse_results(data, target_path)
            return []
            
        except Exception as e:
            print(f"SAST scan error: {e}")
            return []
    
    def parse_results(self, data: Dict, target: str) -> List[Dict]:
        findings = []
        
        if "results" in data:
            for issue in data["results"]:
                severity_map = {
                    "HIGH": "high",
                    "MEDIUM": "medium",
                    "LOW": "low"
                }
                
                finding = {
                    "type": "sast",
                    "severity": severity_map.get(issue.get("issue_severity", "LOW"), "low"),
                    "title": issue.get("issue_text", "Unknown issue"),
                    "file": issue.get("filename", ""),
                    "line": issue.get("line_number", 0),
                    "code": issue.get("code", ""),
                    "cwe": issue.get("issue_cwe", {}).get("id", "")
                }
                findings.append(finding)
        
        return findings

def run_sast_scan(target_path: str) -> Dict:
    scanner = SASTScanner()
    findings = scanner.scan(target_path)
    
    return {
        "scanner": "SAST (Bandit)",
        "target": target_path,
        "findings_count": len(findings),
        "findings": findings
    }
